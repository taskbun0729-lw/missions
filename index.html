<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>今日の極秘任務</title>
  <style>
    body { font-family: system-ui,-apple-system,BlinkMacSystemFont; padding:24px; text-align:center; }
    .q { font-size:1.1rem; opacity:.85; margin-bottom:14px; }
    .btn {
      font-size:1.1rem; padding:12px 16px; border-radius:12px;
      border:1px solid #ccc; background:#fff; cursor:pointer;
    }
    .btn:disabled { opacity:.6; cursor:default; }
    .a { margin-top:18px; font-size:1.6rem; font-weight:700; line-height:1.4; white-space:pre-wrap; }
    .meta { margin-top:14px; font-size:.9rem; opacity:.6; }
  </style>
</head>
<body>
  <div class="q">ボタンを押すと、今日のUR★極秘任務のサーバーを表示します。</div>

  <button class="btn" id="btn">今日のUR★サーバーは？</button>

  <div class="a" id="answer" style="display:none;"></div>
  <div class="meta" id="meta" style="display:none;"></div>

<script>
  // ▼ここだけ差し替え（Googleシートを「ウェブに公開」で出たCSV URL）
  const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQEEIV5e8bKRn52JeHNXySH4aZcce39QM-GY7lD6eh--_tZ5M1JZomfcWeOhzacscWyHEHDC7YC6MFO/pub?output=csv";

  // JST（UTC+9固定）
  function nowJST() {
    return new Date(Date.now() + 9 * 60 * 60 * 1000);
  }

  // JST 11:00で任務日切替（11:00前は前日扱い）
  function missionDateKey() {
    const jst = nowJST();
    const y = jst.getUTCFullYear();
    const m = jst.getUTCMonth();
    const d = jst.getUTCDate();
    const h = jst.getUTCHours();

    const base = new Date(Date.UTC(y, m, d));
    if (h < 11) base.setUTCDate(base.getUTCDate() - 1);

    const yy = base.getUTCFullYear();
    const mm = String(base.getUTCMonth() + 1).padStart(2, "0");
    const dd = String(base.getUTCDate()).padStart(2, "0");
    return `${yy}-${mm}-${dd}`;
  }

  // 3パターン日替わり
  function dailyIndex3(dateKey) {
    const [y, m, d] = dateKey.split("-").map(Number);
    const dayNumber = Date.UTC(y, m - 1, d) / 86400000;
    return ((dayNumber % 3) + 3) % 3;
  }

  function parseCSV(text) {
    const lines = text.trim().split(/\r?\n/);
    return lines.map(line => {
      const out = [];
      let cur = "", inQ = false;
      for (let i=0; i<line.length; i++) {
        const c = line[i];
        if (c === '"') {
          if (inQ && line[i+1] === '"') { cur += '"'; i++; }
          else inQ = !inQ;
        } else if (c === "," && !inQ) {
          out.push(cur); cur = "";
        } else cur += c;
      }
      out.push(cur);
      return out;
    });
  }

  async function fetchMission() {
    const dateKey = missionDateKey();
    const idx = dailyIndex3(dateKey);

    const res = await fetch(SHEET_CSV_URL, { cache: "no-store" });
    if (!res.ok) throw new Error("Sheet fetch failed");
    const csv = await res.text();
    const rows = parseCSV(csv);

    const map = new Map();
    for (let i=1; i<rows.length; i++) {
      const [id, text] = rows[i];
      if (id === undefined || text === undefined) continue;
      map.set(String(id).trim(), text);
    }

    return {
      dateKey,
      idx,
      text: map.get(String(idx)) ?? "（任務が未設定です：id 0/1/2 を確認）"
    };
  }

  const btn = document.getElementById("btn");
  const answerEl = document.getElementById("answer");
  const metaEl = document.getElementById("meta");

  btn.addEventListener("click", async () => {
    btn.disabled = true;
    btn.textContent = "確認中…";

    try {
      const { dateKey, idx, text } = await fetchMission();
      answerEl.style.display = "block";
      metaEl.style.display = "block";
      answerEl.textContent = text;
      metaEl.textContent = `任務日: ${dateKey} / パターン: ${idx+1}（JST 11:00切替）`;
      btn.textContent = "もう一度見る";
    } catch (err) {
      answerEl.style.display = "block";
      metaEl.style.display = "block";
      answerEl.textContent = "読み込みに失敗しました（公開URL/公開設定を確認）";
      metaEl.textContent = String(err);
      btn.textContent = "再試行";
    } finally {
      btn.disabled = false;
    }
  });
</script>
</body>
</html>
