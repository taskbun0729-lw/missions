<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>今日の極秘任務（★つき）/ Today's Secret Mobile Squad(UR★)</title>
  <style>
    body { font-family: system-ui,-apple-system,BlinkMacSystemFont; padding:24px; text-align:center; }
    .q { font-size:1.1rem; opacity:.85; margin-bottom:14px; }
    .btn {
      font-size:1.1rem; padding:12px 16px; border-radius:12px;
      border:1px solid #ccc; background:#fff; cursor:pointer;
    }
    .btn:disabled { opacity:.6; cursor:default; }
    .a { margin-top:18px; font-size:1.6rem; font-weight:700; line-height:1.4; white-space:pre-wrap; }
    .meta { margin-top:14px; font-size:.9rem; opacity:.6; }

    .notice {
      margin-top: 16px;
      font-size: 0.9rem;
      opacity: 0.85;
      text-align: left;
      display: inline-block;
    }

    .notice summary {
      cursor: pointer;
      font-weight: 600;
      list-style: none;
    }

    .notice summary::-webkit-details-marker {
      display: none;
    }

    .notice summary::before {
      content: "▶ ";
      font-size: 0.85em;
    }

    .notice[open] summary::before {
      content: "▼ ";
    }

    .notice ul {
      margin: 8px 0 0 1.2em;
      padding: 0;
    }

    .notice li {
      margin-bottom: 6px;
    }
  </style>
</head>
<body>
  <div class="q">ボタンを押すと、今日のUR星つき極秘任務のサーバーを表示します。</div>

  <div style="margin-bottom:12px;">
    <label>
      日付を指定：
      <input type="date" id="datePicker">
    </label>
    <button class="btn" id="setDateBtn" style="margin-left:6px;">この日で確認</button>
    <button class="btn" id="clearDateBtn" style="margin-left:6px;">今日に戻る</button>
  </div>

  <button class="btn" id="btn">今日のキラキラサーバーは？</button>

  <div class="a" id="answer" style="display:none;"></div>
  <div class="meta" id="meta" style="display:none;"></div>

  <details id="notice" class="notice" style="display:none;">
    <summary>注意事項</summary>
    <ul>
      <li>★付き任務は、<strong>火・水・土</strong>に実行されます。</li>
      <li>本内容は、すべてのケースで検証できているものではありません。</li>
      <li>ご意見・ご要望は、<strong>813-PCv</strong>までお寄せください。</li>
    </ul>
  </details>

<script>
  // ▼ここだけ差し替え（Googleシートを「ウェブに公開」で出たCSV URL）
  const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQEEIV5e8bKRn52JeHNXySH4aZcce39QM-GY7lD6eh--_tZ5M1JZomfcWeOhzacscWyHEHDC7YC6MFO/pub?output=csv";

  // テスト用：URLで任務日を固定（例：?test=2026-01-16）
  function getTestDateParam() {
    const p = new URLSearchParams(location.search);
    const s = p.get("test");
    if (!s) return null;
    if (!/^\d{4}-\d{2}-\d{2}$/.test(s)) return null;
    return s;
  }

  function setMainButtonLabel() {
    const test = getTestDateParam();
    const btn = document.getElementById("btn");
    if (!btn) return;
    btn.textContent = test ? "指定日のキラキラサーバーは？" : "今日のキラキラサーバーは？";
  }

  // URLの test を v に更新してリロード
  function goToTestDate(v) {
    const url = new URL(location.href);
    url.searchParams.set("test", v);
    location.href = url.toString();
  }

  // JST（UTC+9固定）
  function nowJST() {
    return new Date(Date.now() + 9 * 60 * 60 * 1000);
  }

  // JST 11:00で任務日切替（11:00前は前日扱い）
  function missionDateKey() {
    const jst = nowJST();
    const y = jst.getUTCFullYear();
    const m = jst.getUTCMonth();
    const d = jst.getUTCDate();
    const h = jst.getUTCHours();

    const base = new Date(Date.UTC(y, m, d));
    if (h < 11) base.setUTCDate(base.getUTCDate() - 1);

    const yy = base.getUTCFullYear();
    const mm = String(base.getUTCMonth() + 1).padStart(2, "0");
    const dd = String(base.getUTCDate()).padStart(2, "0");

    // URLに test=YYYY-MM-DD があればそれを優先
    const test = getTestDateParam();
    if (test) return test;

    return `${yy}-${mm}-${dd}`;
  }

  // パターンの基準日調整（ズレたらここを +1 / -1 で合わせる）
  const PATTERN_OFFSET_DAYS = -1;

  // 3パターン日替わり
  function dailyIndex3(dateKey) {
    const [y, m, d] = dateKey.split("-").map(Number);
    const dayNumber = Date.UTC(y, m - 1, d) / 86400000;
    const adjusted = dayNumber + PATTERN_OFFSET_DAYS;
    return ((adjusted % 3) + 3) % 3; // 0..2
  }

  function parseCSV(text) {
    const lines = text.trim().split(/\r?\n/);
    return lines.map(line => {
      const out = [];
      let cur = "", inQ = false;
      for (let i=0; i<line.length; i++) {
        const c = line[i];
        if (c === '"') {
          if (inQ && line[i+1] === '"') { cur += '"'; i++; }
          else inQ = !inQ;
        } else if (c === "," && !inQ) {
          out.push(cur); cur = "";
        } else cur += c;
      }
      out.push(cur);
      return out;
    });
  }

  async function fetchMission() {
    const dateKey = missionDateKey();
    const idx = dailyIndex3(dateKey);

    const res = await fetch(SHEET_CSV_URL, { cache: "no-store" });
    if (!res.ok) throw new Error("Sheet fetch failed");
    const csv = await res.text();
    const rows = parseCSV(csv);

    // 1行目はヘッダー想定（id,text）
    const map = new Map();
    for (let i=1; i<rows.length; i++) {
      const [id, text] = rows[i];
      if (id === undefined || text === undefined) continue;
      map.set(String(id).trim(), text);
    }

    return {
      dateKey,
      idx,
      text: map.get(String(idx)) ?? "（任務が未設定です：id 0/1/2 を確認）"
    };
  }

  const btn = document.getElementById("btn");
  const answerEl = document.getElementById("answer");
  const metaEl = document.getElementById("meta");
  const noticeEl = document.getElementById("notice");

  // 初期表示でボタン文言を整える
  setMainButtonLabel();

  btn.addEventListener("click", async () => {
    btn.disabled = true;
    btn.textContent = "確認中…";

    try {
      const { dateKey, idx, text } = await fetchMission();
      answerEl.style.display = "block";
      metaEl.style.display = "block";
      if (noticeEl) noticeEl.style.display = "inline-block";

      answerEl.textContent = text;

      const test = getTestDateParam();
      metaEl.textContent = `任務日: ${dateKey} / パターン: ${idx+1}（JST 11:00切替）${test ? " ※指定日" : ""}`;

      // ここで文言を戻す
      setMainButtonLabel();
    } catch (err) {
      answerEl.style.display = "block";
      metaEl.style.display = "block";
      answerEl.textContent = "読み込みに失敗しました（公開URL/公開設定を確認）";
      metaEl.textContent = String(err);
      btn.textContent = "再試行";
    } finally {
      btn.disabled = false;
    }
  });

  // 日付指定 → test=YYYY-MM-DD をURLに付けて再読み込み
  const datePicker = document.getElementById("datePicker");
  const setDateBtn = document.getElementById("setDateBtn");
  const clearDateBtn = document.getElementById("clearDateBtn");

  if (datePicker && setDateBtn) {
    // ボタンで確認（従来通り）
    setDateBtn.addEventListener("click", () => {
      const v = datePicker.value; // YYYY-MM-DD
      if (!v) {
        alert("日付を選んでください");
        return;
      }
      goToTestDate(v);
    });

    // ★追加：日付を選んだ瞬間に自動で切り替え
    datePicker.addEventListener("change", () => {
      const v = datePicker.value;
      if (!v) return;
      goToTestDate(v);
    });

    // URLに test= が付いていたら、ピッカーにも反映
    const initialTest = getTestDateParam();
    if (initialTest) datePicker.value = initialTest;
  }

  // 今日に戻る（test パラメータを外す）
  if (clearDateBtn) {
    clearDateBtn.addEventListener("click", () => {
      const url = new URL(location.href);
      url.searchParams.delete("test");
      location.href = url.toString();
    });
  }
</script>
</body>
</html>
